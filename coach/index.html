<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0c204a">
  <title>Operation Sky Core â€” Coach Dashboard v1.3 (FIXED)</title>
  <style>
    :root{--bg:#0c204a;--panel:#163678;--text:#e7eef9;--muted:#a0b8d6;--border:#263a64;--accent:#2d6edc}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    input,select,button{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .badge{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted);margin-right:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    .table th{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px}
    .kpi .box{background:#0e2a5f;border:1px solid var(--border);border-radius:12px;padding:10px}
    .kpi .val{font-size:20px;font-weight:700}
    .progress{height:8px;background:#0b1a3a;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .progress>div{height:100%;background:var(--accent);width:0%}
    a.btn,button.btn,label.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);text-decoration:none}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row">
      <h1>Operation Sky Core â€” Coach Dashboard <span class="small">(v1.3 - FIXED FOR V2.0 API)</span></h1>
      <div class="row">
        <span class="badge">Core Butte Lynx</span>
        <span class="badge">Blue & White</span>
      </div>
    </header>

    <!-- Login -->
    <div id="loginCard" class="card">
      <strong>Coach Login</strong>
      <div class="row" style="margin-top:8px">
        <input id="pw" type="password" placeholder="Password">
        <button id="loginBtn" class="btn">Enter</button>
        <span class="small">Hint: mascot + year + !</span>
      </div>
      <div id="loginErr" class="small" style="color:#ffb3b3;margin-top:6px;display:none">Incorrect password</div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Team Overview</strong>
          <div class="row">
            <button id="refresh" class="btn">Refresh</button>
            <button id="addMock" class="btn">Add Mock Players</button>
            <button id="exportJSON" class="btn">Export Team JSON</button>
            <label class="btn"><input id="importFile" type="file" accept="application/json" style="display:none">Import Team JSON</label>
          </div>
        </div>
        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="small">Players</div><div id="kPlayers" class="val">0</div></div>
          <div class="box"><div class="small">Avg XP</div><div id="kAvgXP" class="val">0</div></div>
          <div class="box"><div class="small">Avg Streak</div><div id="kAvgStreak" class="val">0</div></div>
          <div class="box"><div class="small">Today Completion</div><div class="progress"><div id="kAvgProg"></div></div></div>
        </div>
        <div id="debugInfo" class="small" style="margin-top:10px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px;display:none"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Players</strong>
          <div class="row">
            <select id="filterWeek"></select>
            <select id="filterDay">
              <option value="1">Day 1</option>
              <option value="2">Day 2</option>
              <option value="3">Day 3</option>
            </select>
            <input id="search" placeholder="Search by nameâ€¦">
          </div>
        </div>

        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Player</th><th>Week</th><th>Day</th><th>Completed</th><th>XP</th><th>Streak</th><th>Badges</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="small">Delete removes only from this dashboard storage.</div>
      </div>

      <div class="card">
        <strong>Selected Player Detail</strong>
        <div id="detail" class="small">Choose a player row for a breakdown.</div>
      </div>

      <footer class="small">
        <span class="badge">Static coach build</span>
        <span class="badge">Pulls from Player config</span>
        <span class="badge">JSON import and export</span>
        <span class="badge">Local password session</span>
        <span class="badge">V2.0 API Compatible</span>
      </footer>
    </div>
  </div>

  <script>
    // Password gate
    const PASS = "Lynx2025!";
    const SESSION_KEY = "osc_coach_authed";
    const loginCard = document.getElementById('loginCard');
    const appEl     = document.getElementById('app');
    const pw        = document.getElementById('pw');
    const loginBtn  = document.getElementById('loginBtn');
    const loginErr  = document.getElementById('loginErr');
    const debugInfo = document.getElementById('debugInfo');
    
    function showApp(){ loginCard.classList.add('hidden'); appEl.classList.remove('hidden'); }
    function requireLogin(){
      if(localStorage.getItem(SESSION_KEY)==="yes"){ showApp(); init(); return; }
      loginCard.classList.remove('hidden'); appEl.classList.add('hidden');
    }
    loginBtn.onclick=()=>{
      if((pw.value||"").trim()===PASS){ localStorage.setItem(SESSION_KEY,"yes"); showApp(); init(); }
      else { loginErr.style.display='block'; setTimeout(()=>loginErr.style.display='none', 2000); }
    };
    pw.addEventListener('keydown',e=>{ if(e.key==="Enter") loginBtn.click(); });

    // Helpers
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const clampPct = v => Math.max(0, Math.min(100, Math.round(v)));

    // Program model (fallback if API does not provide totals)
    const WEEKS=12;
    const PROGRAM={1:{warmup:5,strength:[4,3,3,3,4],core:2,jump:3},
                   2:{warmup:5,strength:[4,3,3,3,3],core:4,jump:4},
                   3:{warmup:4,strength:[4,4,3,3,3],core:2,jump:3}};
    function totalBoxesForDay(day){
      const p=PROGRAM[day]||PROGRAM[1];
      const strengthSets=p.strength.reduce((a,b)=>a+b,0);
      return p.warmup + p.core + p.jump + strengthSets;
    }

    // Store
    const STORE_KEY="osc_coach_store_v1";
    function loadStore(){ return JSON.parse(localStorage.getItem(STORE_KEY)||'{"players":{}}'); }
    function saveStore(v){ localStorage.setItem(STORE_KEY, JSON.stringify(v)); }

    // UI refs
    const kPlayers=document.getElementById('kPlayers');
    const kAvgXP=document.getElementById('kAvgXP');
    const kAvgStreak=document.getElementById('kAvgStreak');
    const kAvgProg=document.getElementById('kAvgProg');
    const filterWeek=document.getElementById('filterWeek');
    const filterDay=document.getElementById('filterDay');
    const search=document.getElementById('search');
    const tbody=document.getElementById('tbody');
    const detail=document.getElementById('detail');
    const addMock=document.getElementById('addMock');
    const exportJSON=document.getElementById('exportJSON');
    const importFile=document.getElementById('importFile');
    const refreshBtn=document.getElementById('refresh');

    for(let w=1; w<=WEEKS; w++){ const o=document.createElement('option'); o.value=w; o.textContent="Week "+w; filterWeek.appendChild(o); }
    filterWeek.value="1";

   // Config from player build
let sheetUrl = "";   // read-only list
let syncUrl  = "";   // mutations (delete)
async function loadConfig(){
  sheetUrl = ""; syncUrl = "";
  try{
    let r = await fetch("../player/config.json?t="+Date.now(), {cache:"no-store"});
    if(!r.ok) r = await fetch("../config.json?t="+Date.now(), {cache:"no-store"});
    if(r.ok){
      const j = await r.json();
      sheetUrl = j.coachUrl || "";
      syncUrl  = j.coachSyncUrl || "";
      console.log("âœ… Config loaded:", {sheetUrl, syncUrl});
    }
  }catch(err){
    console.error("âŒ Config load failed:", err);
  }
}

    // ===== FIXED: Pull from V2.0 Apps Script JSON (doGet) =====
    async function loadPlayersFromSheet(){
      if(!sheetUrl) {
        console.warn("âš ï¸ No sheetUrl configured");
        return;
      }
      
      console.log("ðŸ“¡ Fetching from:", sheetUrl);
      
      try{
        const res = await fetch(sheetUrl+"?t="+Date.now(), {cache:"no-store"});
        
        if(!res.ok){
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log("ðŸ“¥ Received data:", data);
        
        if(!data || !data.ok){
          throw new Error("Invalid response: " + JSON.stringify(data));
        }
        
        if(!data.players || Object.keys(data.players).length === 0){
          console.warn("âš ï¸ No players in response");
          saveStore({ players: {} });
          return;
        }
        
        const store = { players: {} };
        let playerCount = 0;
        
        // V2.0 API uses currentWeek, currentDay, and nested currentWorkout
        for (const [name, rec] of Object.entries(data.players)){
          playerCount++;
          console.log(`Processing player ${playerCount}:`, name, rec);
          
          // Map V2.0 API structure to coach app structure
          const week = Number(rec.currentWeek || rec.week || 1);
          const day = Number(rec.currentDay || rec.day || 1);
          
          // currentWorkout contains completion data
          const workout = rec.currentWorkout || {};
          const total = Number(workout.total || rec.total || 0) || totalBoxesForDay(day);
          const done = Math.min(Number(workout.completed || rec.completed || 0), total);
          
          store.players[name] = {
            name,
            xp: Number(rec.xp||0),
            streak: Number(rec.streak||0),  // Will be 0 if not provided
            week: week,
            day: day,
            completed: done,
            total: total
          };
          
          console.log(`âœ“ Mapped ${name}:`, store.players[name]);
        }
        
        saveStore(store);
        console.log(`âœ… Successfully loaded ${playerCount} players from sheet`);
        
        // Show debug info
        debugInfo.textContent = `Last sync: ${new Date().toLocaleTimeString()} - ${playerCount} players loaded`;
        debugInfo.style.display = 'block';
        
      }catch(err){
        console.error("âŒ Sheet load failed:", err);
        debugInfo.textContent = `Error: ${err.message}`;
        debugInfo.style.display = 'block';
        debugInfo.style.color = '#ffb3b3';
      }
    }

// ==== API helpers for server delete ====
async function apiCall(payload){
  if(!syncUrl) throw new Error("syncUrl not configured");
  
  const res = await fetch(syncUrl, {
    method:"POST",
    mode: "no-cors",
    headers:{ "Content-Type":"text/plain" },
    body: JSON.stringify(payload),
  });
  
  return { ok: true };
}

async function deletePlayerEverywhere(name){
  if(!syncUrl) throw new Error("syncUrl not configured");
  
  // Use GET request with query parameter - no CORS issues
  const url = syncUrl + "?deletePlayer=" + encodeURIComponent(name);
  const res = await fetch(url);
  const j = await res.json();
  
  if(!j || j.ok !== true) {
    throw new Error((j && j.error) || "Delete failed");
  }
  
  return j;
}

    // Render
    function render(){
      const store=loadStore();
      const names=Object.keys(store.players);

      let avgXP=0, avgStreak=0, avgProg=0, rows=[];
      const w=+filterWeek.value, d=+filterDay.value; const q=(search.value||"").toLowerCase();

      names.forEach(n=>{
        const p=store.players[n];
        if(!p) return;
        if(q && !n.toLowerCase().includes(q)) return;
        const week=p.week||w, day=p.day||d;
        const total=(p.total && p.day===day && p.week===week) ? p.total : totalBoxesForDay(day);
        const done=Math.min(p.completed||0,total);
        rows.push({name:n, xp:p.xp||0, streak:p.streak||0, week, day, done, total});
      });

      kPlayers.textContent = rows.length;
      if(rows.length){
        avgXP = Math.round(rows.reduce((a,r)=>a+r.xp,0)/rows.length);
        avgStreak = Math.round(rows.reduce((a,r)=>a+r.streak,0)/rows.length);
        const progVals = rows.map(r=> r.total>0 ? (r.done/r.total) : 0);
        avgProg = clampPct(100 * progVals.reduce((a,b)=>a+b,0)/rows.length);
      }
      kAvgXP.textContent=avgXP; kAvgStreak.textContent=avgStreak; kAvgProg.style.width=(avgProg||0)+"%";

      tbody.innerHTML="";
      rows.sort((a,b)=>a.name.localeCompare(b.name)).forEach(r=>{
        const tr=document.createElement('tr');
        const pct = r.total>0 ? clampPct(100*r.done/r.total) : 0;
        const badges = (r.xp>=600)?["Gold"] : (r.xp>=300)?["Silver"] : (r.xp>=100)?["Bronze"] : [];
        tr.innerHTML = `
          <td>${esc(r.name)}</td>
          <td>${r.week}</td>
          <td>${["","Day 1","Day 2","Day 3"][r.day]}</td>
          <td>${r.done} / ${r.total||0}
              <div class="progress" style="margin-top:4px"><div style="width:${pct}%"></div></div></td>
          <td>${r.xp}</td>
          <td>${r.streak}</td>
          <td>${badges.join(", ")||"-"}</td>
          <td>
            <button class="btn" data-view="${esc(r.name)}">View</button>
            <button class="btn" data-del="${esc(r.name)}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function setDetail(name){
      const p=loadStore().players[name];
      if(!p){ detail.textContent="No data."; return; }
      const total = p.total || totalBoxesForDay(p.day||1);
      const done  = Math.min(p.completed||0,total);
      detail.innerHTML = `
        <div class="row"><strong>${esc(name)}</strong><span class="badge">Week ${p.week||1}</span><span class="badge">${["","Day 1","Day 2","Day 3"][p.day||1]}</span></div>
        <div class="row small" style="margin-top:6px">
          <span>XP: <b>${p.xp||0}</b></span>
          <span>Streak: <b>${p.streak||0}</b></span>
          <span>Completed: <b>${done}</b> / ${total}</span>
        </div>
        <div class="progress" style="margin-top:6px"><div style="width:${clampPct(total?100*done/total:0)}%"></div></div>
      `;
    }

    // Events
    document.addEventListener('click', async e=>{
      const v=e.target.getAttribute && e.target.getAttribute('data-view');
      const del=e.target.getAttribute && e.target.getAttribute('data-del');
      
      if(v){ 
        setDetail(v); 
      }
      
      if (del) {
        if (confirm(`Permanently delete ${del} from Sheets and this dashboard?`)) {
          try {
            await deletePlayerEverywhere(del);
            const store = loadStore();
            delete store.players[del];
            saveStore(store);
            render();
            detail.textContent = `Player "${del}" deleted from Sheets and dashboard.`;
          } catch (err) {
            alert("Delete failed: " + (err && err.message ? err.message : err));
          }
        }
      }
    });
    
    filterWeek.onchange=render; filterDay.onchange=render; search.oninput=render;
    refreshBtn.onclick=async()=>{ await loadConfig(); await loadPlayersFromSheet(); render(); };

    // Mock and import/export
    function mockPlayer(name){
      const week=1+Math.floor(Math.random()*WEEKS);
      const day=1+Math.floor(Math.random()*3);
      const total=totalBoxesForDay(day);
      const done=Math.floor(total*(0.4+Math.random()*0.6));
      return {name,week,day,total,completed:done,xp:Math.floor(50+Math.random()*400),streak:Math.floor(Math.random()*10)};
    }
    addMock.onclick=()=>{
      const store=loadStore();
      ["Sam","AJ","Trey","Miles","Jordan","Evan","Noah","Zach"].forEach(n=>{ store.players[n]=mockPlayer(n); });
      saveStore(store); render();
    };
    exportJSON.onclick=()=>{
      const blob=new Blob([JSON.stringify(loadStore(),null,2)],{type:"application/json"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="osc_team.json"; a.click();
    };
    document.querySelector('label.btn').onclick=()=>importFile.click();
    importFile.onchange=(e)=>{
      const f=e.target.files && e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ try{
          const incoming=JSON.parse(r.result);
          if(!incoming || !incoming.players) throw new Error("Invalid file");
          saveStore(incoming); render(); detail.textContent="Imported team JSON.";
        }catch(err){ alert("Import failed: "+err.message); }
      };
      r.readAsText(f);
    };

    // Init
    async function init(){
      console.log("ðŸš€ Initializing coach dashboard...");
      const store=loadStore();
      if(!store.players) saveStore({players:{}});
      filterWeek.value = filterWeek.value || "1";
      filterDay.value = filterDay.value || "1";
      await loadConfig();
      await loadPlayersFromSheet();
      render();
    }

    requireLogin();
  </script>
</body>
</html>
