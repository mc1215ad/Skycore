<!doctype html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0c204a">
<title>Operation Sky Core — <span id="phaseTitle">Phase</span></title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;700&display=swap');

:root{
  --bg:#0a0e1a;
  --bg-elevated:#151b2e;
  --bg-card:#1a2238;
  --text:#e8edf5;
  --text-dim:#7d8ba3;
  --border:#252f45;
  --accent:#00d9ff;
  --accent-glow:rgba(0,217,255,0.3);
  --gold:#ffd700;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  color:var(--text);
  font-family:'Inter',system-ui,sans-serif;
  line-height:1.5;
  overflow-x:hidden;
  min-height:100vh;
}

body::before{
  content:'';
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:radial-gradient(circle at 20% 30%, rgba(0,217,255,0.08) 0%, transparent 40%),
             radial-gradient(circle at 80% 70%, rgba(99,102,241,0.06) 0%, transparent 40%);
  pointer-events:none;
  z-index:0;
}

.wrap{
  max-width:640px;
  margin:0 auto;
  padding:20px 16px 40px;
  position:relative;
  z-index:1;
}

header{
  text-align:center;
  padding:32px 0 24px;
}

h1{
  font-family:'Rajdhani',sans-serif;
  font-size:32px;
  font-weight:700;
  letter-spacing:4px;
  text-transform:uppercase;
  background:linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:8px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:center;
  margin-bottom:20px;
}

#hdr{
  justify-content:center;
  margin:20px 0;
}

.chip{
  background:var(--bg-card);
  border:2px solid var(--border);
  padding:10px 16px;
  border-radius:20px;
  font-family:'Rajdhani',sans-serif;
  font-size:13px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--accent);
  transition:all 0.3s;
}

.chip:hover{
  border-color:var(--accent);
  box-shadow:0 4px 12px rgba(0,217,255,0.2);
}

.lynx{display:inline-flex;align-items:center;gap:6px}
.lynx:before{content:"🐾"}

.badges{
  display:flex;
  gap:10px;
}

.badge{
  background:var(--bg-elevated);
  border:2px solid var(--border);
  padding:8px 16px;
  border-radius:24px;
  font-family:'Rajdhani',sans-serif;
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--text-dim);
  transition:all 0.3s;
}

input,select,button,textarea{
  background:var(--bg-card);
  border:1px solid var(--border);
  color:var(--text);
  padding:12px 16px;
  border-radius:12px;
  font-size:14px;
  font-weight:700;
  font-family:'Rajdhani',sans-serif;
  text-transform:uppercase;
  letter-spacing:1px;
  transition:all 0.2s;
}

button{cursor:pointer}

button:hover,select:hover{
  background:var(--bg-elevated);
  border-color:var(--accent);
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(0,217,255,0.2);
}

.card{
  background:var(--bg-card);
  border:2px solid var(--border);
  border-radius:20px;
  padding:24px;
  margin:16px 0;
  transition:all 0.3s;
}

.card:hover{
  border-color:var(--accent);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}

.card strong{
  font-family:'Rajdhani',sans-serif;
  font-size:18px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:3px;
  color:var(--accent);
  display:block;
  margin-bottom:16px;
}

.progress{
  height:14px;
  background:var(--bg-elevated);
  border-radius:20px;
  overflow:hidden;
  border:1px solid var(--border);
}

.progress>div{
  height:100%;
  background:linear-gradient(90deg, var(--accent), #6366f1, var(--accent));
  background-size:200% 100%;
  animation:shimmer 3s linear infinite;
  transition:width 0.6s ease;
  box-shadow:0 0 20px var(--accent-glow);
}

@keyframes shimmer{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

.grid{
  display:grid;
  grid-template-columns:1fr 60px 70px 1fr;
  gap:8px;
  align-items:center;
}

.gridHeader{
  color:var(--text-dim);
  font-weight:700;
  font-size:12px;
  font-family:'Rajdhani',sans-serif;
  text-transform:uppercase;
  letter-spacing:1px;
}

.note,textarea{
  width:100%;
  min-height:100px;
  background:var(--bg);
  border:1px solid var(--border);
  color:var(--text);
  padding:12px;
  border-radius:10px;
  font-size:14px;
  font-family:inherit;
  resize:vertical;
  text-transform:none;
  letter-spacing:normal;
  font-weight:normal;
}

textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px var(--accent-glow);
}

.exercise-link{
  text-decoration:underline;
  cursor:pointer;
  color:var(--text);
  transition:color 0.2s;
}

.exercise-link:hover{
  color:var(--accent);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.92);
  backdrop-filter:blur(12px);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:1000;
}

.modal .box{
  background:var(--bg-card);
  border:2px solid var(--border);
  max-width:560px;
  width:100%;
  border-radius:24px;
  overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,0.8);
}

.modal header{
  padding:24px;
  border-bottom:2px solid var(--border);
  background:var(--bg-elevated);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal .content{padding:28px}

.modal h3{
  margin:0;
  font-family:'Rajdhani',sans-serif;
  font-size:22px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--accent);
}

.modal ul{
  margin:.5rem 0 1rem 0;
  padding:0;
  list-style:none;
}

.modal li{
  padding:10px 0 10px 20px;
  position:relative;
  color:var(--text);
  font-size:15px;
  line-height:1.6;
}

.modal li::before{
  content:'▸';
  position:absolute;
  left:0;
  color:var(--accent);
  font-size:18px;
}

.modal .close{
  background:transparent;
  border:none;
  color:var(--text-dim);
  font-size:24px;
  cursor:pointer;
  padding:8px 12px;
  border-radius:10px;
  transition:all 0.2s;
}

.modal .close:hover{
  background:var(--bg-card);
  color:var(--accent);
  transform:rotate(90deg);
}

.muted,.small{
  font-size:12px;
  color:var(--text-dim);
  font-family:'Rajdhani',sans-serif;
  text-transform:uppercase;
  letter-spacing:1.5px;
  font-weight:700;
  margin:16px 0 8px;
}

.hidden{display:none}
#player,#addPlayer{display:none!important}

@media(max-width:480px){
  h1{font-size:24px;letter-spacing:3px}
  .chip{font-size:11px;padding:8px 12px}
}
  .card .row,
.card .grid,
.card label,
.card input[type="checkbox"] + span {
  text-align: left;
  justify-content: flex-start;
}
</style></head>
<body>
<div class="wrap">
  <header class="row">
    <h1>Operation Sky Core — <span id="phaseLabel">Phase 1</span> <span class="small" id="verLabel">(Player v3.2.2)</span></h1>
    <div class="row">
      <select id="daySel"><option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option></select>
      <select id="week"></select>
      <button id="exportCsv">Export</button>
    </div>
  </header>

  <div class="row" id="hdr">
    <span class="chip lynx" id="schoolTag">CORE Butte High Lynx | Blue & White</span>
    <span class="chip" id="playerChip"></span>
    <span class="chip" id="xp">XP 0</span>
    <div class="badges" id="badges" title="Bronze=100 XP, Silver=300 XP, Gold=600 XP"></div>
  </div>

  <div class="card">
    <strong>Progress</strong>
    <div class="progress" style="margin-top:8px"><div id="xpbar"></div></div>
  </div>

  <div class="card"><strong>Why today matters</strong><div id="why"></div></div>
  <div id="content"></div>
  <div class="card"><strong>Notes</strong><textarea id="notes" class="note" placeholder="Notes for today..."></textarea></div>
</div>

<div class="modal" id="trainerModal">
  <div class="box">
    <header class="row"><h3 id="mTitle">Exercise</h3><button class="close" id="mClose">Close</button></header>
    <div class="content">
      <div class="muted">Setup</div><ul id="mSetup"></ul>
      <div class="muted">Execution</div><ul id="mExec"></ul>
      <div class="muted">Focus cues</div><ul id="mFocus"></ul>
      <div class="muted">Common mistakes</div><ul id="mMistakes"></ul>
      <div class="muted">Why this increases vertical</div><ul id="mWhy"></ul>
    </div>
  </div>
</div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}

/* Post with every save */
let COACH_URL = "";
fetch("./config.json").then(r=>r.json()).then(c=>{
  COACH_URL = (c && c.coachUrl) || "";
}).catch(()=>{ COACH_URL = ""; });
  
async function sendCoachSnapshot(){
  try{
    if(!COACH_URL) return;

    // get bound player name in player-only build
    const p = currentPlayer() || promptForNameOnce();
    const d = +daySel.value;
    const w = +weekSel.value;

    const payload = {
      player:p, week:w, day:d,
      xp:getXP(p), streak:getStreak(p),
      notes:notes.value,
      entry:loadEntry(p,d,w)||init(d),
      settings:loadSettings(p),
      ts:new Date().toISOString()
    };

    // Try sendBeacon first (fire-and-forget, text/plain only)
    const ok = (navigator.sendBeacon && navigator.sendBeacon(COACH_URL, new Blob([JSON.stringify(payload)], {type:"text/plain"})));
    if(ok) return;

    // Fallback to fetch without CORS preflight
    await fetch(COACH_URL, {
      method: "POST",
      headers: {"Content-Type":"text/plain"},
      body: JSON.stringify(payload),
      mode: "no-cors"
    });
  }catch(_){ /* swallow to avoid interrupting UI */ }
}


  
/* ----- Program content (unchanged) ----- */
const PROGRAM={1:{label:"Day 1 — Lower Body + Jump",why:["Heavy basics raise leg drive and stable landings.","Strong positions protect knees and back."],warmup:["Leg Swings — 10 each","Walking Lunges — 10 each","Bodyweight Squat — 3×10","Standing Calf Raise — 3×10","Light Jumps — 3×5"],strength:[{ex:"Back or Goblet Squat",sets:4,reps:"6–8",weighted:true},{ex:"Romanian Deadlift",sets:3,reps:"8–10",weighted:true},{ex:"Walking Lunges",sets:3,reps:"10 each",weighted:true},{ex:"Bulgarian Split Squat",sets:3,reps:"8 each",weighted:true},{ex:"Standing Calf Raise (Loaded)",sets:4,reps:"12–15",weighted:true}],core:["Hanging Leg Raise — 3×10","Plank — 3×30–45s"],jump:["Two-step approach jumps — 5","Touch rim/backboard — 3×5","Form jumps — 3×10"]},2:{label:"Day 2 — Upper Body + Core",why:["Stronger torso keeps power from leaking.","Arm swing speed adds inches to reach."],warmup:["Arm Circles — 15/15","Band Pull-Apart — 15","Push-up to Down Dog — 8","Shoulder Taps — 10/side","Jumping Jacks — 30s"],strength:[{ex:"Barbell or DB Bench Press",sets:4,reps:"6–8",weighted:true},{ex:"Pull-Ups / Assisted Pull-Ups",sets:3,reps:"6–10",weighted:false},{ex:"Standing Overhead Press",sets:3,reps:"8",weighted:true},{ex:"1-Arm Dumbbell Row",sets:3,reps:"10 each",weighted:true},{ex:"Triceps Dips or Pushdowns",sets:3,reps:"12–15",weighted:false}],core:["Hanging Leg Raise — 3×10","Side Plank — 3×30s each","Stability Ball Roll-outs — 3×12","Bird Dog — 3×10 each"],jump:["MB Chest Pass — 3×10","Overhead MB Slam — 3×10","Clap or Plyo Push-ups — 3×6","Sprint 20 yds × 6"]},3:{label:"Day 3 — Plyos + Practice",why:["Fast contacts train spring.","Approach jumps wire skill to power."],warmup:["Dynamic Skips — 2×20 yds","A-Skips & High Knees — 20 yds each","Light Bounding — 2×10","Submax Jumps — 3 at 50–70%"],strength:[{ex:"Box Jump",sets:4,reps:"5",weighted:false},{ex:"Broad Jump",sets:4,reps:"5",weighted:false},{ex:"Lateral Bounds",sets:3,reps:"6 each",weighted:false},{ex:"Depth Drop → Vertical",sets:3,reps:"5",weighted:false},{ex:"Jump Squat (Bodyweight)",sets:3,reps:"8",weighted:false}],core:["Trap/Barbell Deadlift — 4×5","Hip Thrust or Glute Bridge — 3×10"],jump:["Two-step approach jumps — 8","Touch rim/backboard — 3×5","Dunk attempts — 5–10"]}};

/* ----- Coach cards (added missing warm-ups; others unchanged) ----- */
const EX = {
  /* Day 1 warm-ups (existing) */
  "Leg Swings":{setup:["Hold wall or rack for balance","Stand tall; brace lightly"],exec:["Swing forward/back 10–15","Side-to-side 10–15"],focus:["Smooth rhythm","Do not force range"],mistakes:["Wild swings","Torso twisting"],why:["Lubricates hips and prepares for jumping"]},
  "Walking Lunges":{setup:["Tall; optional light DBs"],exec:["Step; lower till back knee hovers; push through front heel"],focus:["Even steps; tall torso","Knee over mid-foot"],mistakes:["Short steps","Torso collapse"],why:["Single-leg strength/balance"]},
  "Bodyweight Squat":{setup:["Feet shoulder width; toes slightly out"],exec:["Sit between heels; chest proud; stand tall"],focus:["Knees over toes","Heels down"],mistakes:["Knees cave","Rounding back"],why:["Grooves squat pattern for safe loading"]},
  "Standing Calf Raise":{setup:["Feet shoulder width; neutral pelvis"],exec:["Rise tall; pause 1s; lower 2–3s"],focus:["Full range","Even forefoot pressure"],mistakes:["Half reps","Ankles rolling"],why:["Improves ankle stiffness and elastic recoil"]},
  "Light Jumps":{setup:["Athletic stance"],exec:["Quick dip; jump lightly; land soft; reset"],focus:["Quiet feet","Mechanics over height"],mistakes:["Stomping","Knees collapse"],why:["Primes nervous system without fatigue"]},

  /* Strength (existing subset) */
  "Back or Goblet Squat":{setup:["Feet shoulder; brace core"],exec:["Lower 2–3s; explode up"],focus:["Depth you control","Brace hard"],mistakes:["Heels up","Knees cave"],why:["Raises leg force for takeoff"]},
  "Romanian Deadlift":{setup:["Feet hip width; soft knees; lats tight"],exec:["Hips back; bar close; stand by squeezing glutes"],focus:["Neutral spine","Bar close"],mistakes:["Locked knees","Bar drifts"],why:["Glute/ham drive adds inches"]},
  "Bulgarian Split Squat":{setup:["Rear foot on bench; front out"],exec:["Lower straight; slight forward torso; drive heel"],focus:["Front leg works","Knee over toes"],mistakes:["Pushing off back leg"],why:["Unilateral force in jump positions"]},
  "Standing Calf Raise (Loaded)":{setup:["Machine or DBs"],exec:["Full rise 1s; slow lower"],focus:["No bounce","Stay tall"],mistakes:["Half reps","Leaning"],why:["Stronger plantarflexors"]},

  /* Core (ensure this exact label matches Day 2 core) */
  "Hanging Leg Raise":{setup:["Hang from bar; ribs down; posterior tilt"],exec:["Lift legs (or knees) to ~hip height; no swing"],focus:["Control the eccentric","Exhale on lift"],mistakes:["Kipping/swinging","Lumbar arch"],why:["Anterior core control for power transfer"]},
  "Plank":{setup:["Elbows under shoulders; straight line"],exec:["Brace glutes/abs; breathe behind brace"],focus:["Neutral spine"],mistakes:["Sagging hips"],why:["Rigid torso transmits leg power"]},

  /* Upper body (existing subset) */
  "Barbell or DB Bench Press":{setup:["Feet planted; shoulders back"],exec:["Lower to mid-chest; elbows ~45°; press over shoulders"],focus:["Stable base","Explosive press"],mistakes:["Flaring elbows"],why:["Faster arm swing/finish"]},
  "Pull-Ups / Assisted Pull-Ups":{setup:["Full hang; core tight"],exec:["Pull chest to bar; elbows down"],focus:["Full range","No swing"],mistakes:["Half reps"],why:["Lat strength stabilizes shoulder"]},
  "Standing Overhead Press":{setup:["Feet hip width; bar at collarbone"],exec:["Press overhead; head through window"],focus:["Straight path","Ribs down"],mistakes:["Overarching back"],why:["Links leg drive to reach"]},
  "1-Arm Dumbbell Row":{setup:["Bench or hinge"],exec:["Pull toward hip; pause top"],focus:["Shoulder down/back"],mistakes:["Yanking"],why:["Anti-rotation for plants/landings"]},
  "Triceps Dips or Pushdowns":{setup:["Bars or cable"],exec:["Elbows close; lower controlled"],focus:["Squeeze lockout"],mistakes:["Flared elbows"],why:["Stronger finish at rim"]},

  /* Day 2 WARM-UPS (ADDED) */
  "Arm Circles":{setup:["Stand tall; arms out at shoulder height"],exec:["Small-to-large circles 15 forward, 15 backward"],focus:["Keep shoulders down/back","Smooth rhythm"],mistakes:["Shrugging","Fast, jerky motion"],why:["Warms GH joint and scapular control for pressing and arm swing"]},
  "Band Pull-Apart":{setup:["Light band at chest height; hands shoulder width or wider"],exec:["Pull by squeezing shoulder blades; return controlled"],focus:["Ribs down","Elbows soft"],mistakes:["Overarching back","Shrugging"],why:["Posterior shoulder + mid-back activation; posture for stronger overhead/pressing"]},
  "Push-up to Down Dog":{setup:["High plank; hands under shoulders"],exec:["One push-up, then drive hips up into Down Dog; repeat"],focus:["Maintain hollow body","Active shoulder flexion at top"],mistakes:["Sagging hips","Neck craning"],why:["Thoracic/shoulder mobility with trunk stiffness—better transfer for upper-day power"]},
  "Shoulder Taps":{setup:["High plank; feet hip–shoulder width"],exec:["Tap opposite shoulder alternating without swaying"],focus:["Hips level","Strong brace"],mistakes:["Hips rocking","Locked-out breath"],why:["Anti-rotation core + shoulder stability for pressing and landings"]},
  "Jumping Jacks":{setup:["Athletic stance"],exec:["Arms and legs move together for 30–45s"],focus:["Rhythm and soft contacts"],mistakes:["Heel slapping","Arms half range"],why:["General warm-up; raises temperature and primes stretch–shortening cycle"]},

  /* Day 3 WARM-UPS (ADDED) */
  "Dynamic Skips":{setup:["Clear 20 yd lane"],exec:["Tall posture; drive knee; opposite arm; skip rhythmically"],focus:["Foot under hips","Crisp arm drive"],mistakes:["Overstriding","Collapsed torso"],why:["Elastic rhythm and coordination before plyometrics"]},
  "A-Skips & High Knees":{setup:["20 yd lane"],exec:["A-Skips 20 yds then High Knees 20 yds"],focus:["Dorsiflexed foot","Knee up, toe up, heel under"],mistakes:["Toe-pointed contacts","Backward lean"],why:["Grooves sprint mechanics and fast contacts for approach jumps"]},
  "Light Bounding":{setup:["Flat space"],exec:["Short forward bounds with soft landings"],focus:["Quick ground contact","Knee over toes alignment"],mistakes:["Heavy stomps","Wobbly knees"],why:["Teaches stiffness and horizontal propulsion safely"]},
  "Submax Jumps":{setup:["Athletic stance"],exec:["3 jumps at 50–70% height; land soft; reset each"],focus:["Quiet feet","Upright torso"],mistakes:["Maxing effort","Heels slamming"],why:["Neural primer for later higher outputs"]},

  /* Day 2 core additions already covered: Hanging Leg Raise above */
  "Side Plank":{setup:["Elbow under shoulder; legs stacked"],exec:["Lift hips; hold straight line"],focus:["Hips high"],mistakes:["Hips dropping"],why:["Resists side-bend on approach"]},
  "Stability Ball Roll-outs":{setup:["Kneel; forearms on ball"],exec:["Roll forward keeping ribs down"],focus:["No low-back arch"],mistakes:["Overreaching"],why:["Anterior core strength for hip drive"]},
  "Bird Dog":{setup:["Hands under shoulders; knees under hips"],exec:["Reach opposite arm/leg; brief hold"],focus:["Hips level"],mistakes:["Twisting"],why:["Cross-body stability used in approach steps"]},

  /* Day 3 strength/plyos (existing) */
  "MB Chest Pass":{setup:["Ball at chest"],exec:["Explode; straight release"],focus:["Fast push; follow-through"],mistakes:["Slow throw"],why:["Upper power, arm swing speed"]},
  "Overhead MB Slam":{setup:["Ball overhead; ribs down"],exec:["Slam hard"],focus:["Full reach then snap"],mistakes:["Overarch"],why:["Triple flexion & trunk snap"]},
  "Clap or Plyo Push-ups":{setup:["Push-up position"],exec:["Explosive push; hands leave floor"],focus:["Speed & control"],mistakes:["Sagging hips"],why:["Upper-body RFD"]},
  "Sprint 20 yds":{setup:["Clear straight line"],exec:["Accelerate; quick turnover"],focus:["Powerful first steps"],mistakes:["Overstride"],why:["Raises neural drive for approaches"]},
  "Box Jump":{setup:["Safe height"],exec:["Load; jump; land soft"],focus:["Quiet landings"],mistakes:["Too-high box"],why:["Rapid force production"]},
  "Broad Jump":{setup:["Flat space"],exec:["Jump forward; stick landing"],focus:["Distance with control"],mistakes:["Falling forward"],why:["Horizontal force & hip drive"]},
  "Lateral Bounds":{setup:["Stand on one leg"],exec:["Explode sideways; land on other"],focus:["Knee alignment"],mistakes:["Wobbly knee"],why:["Side-to-side force & control"]},
  "Depth Drop → Vertical":{setup:["Box 12–18 in"],exec:["Step off; absorb; short contact; jump"],focus:["Soft land; minimal ground time"],mistakes:["Too high box"],why:["Sharpens SSC"]},
  "Jump Squat (Bodyweight)":{setup:["Athletic stance"],exec:["Quick dip; explode; land soft"],focus:["Vertical force"],mistakes:["Too deep"],why:["Speed of force application"]},
  "Trap/Barbell Deadlift":{setup:["Feet hip; bar midfoot"],exec:["Brace; push floor; stand tall"],focus:["Neutral spine; bar close"],mistakes:["Rounding"],why:["Total-body force"]},
  "Hip Thrust or Glute Bridge":{setup:["Shoulders on bench/floor"],exec:["Drive heels; squeeze top"],focus:["Posterior tilt"],mistakes:["Short range"],why:["Direct hip extension power"]},
  "Two-step approach jumps":{setup:["Short two-step run-up"],exec:["Quick plant; load; full arm swing; explode"],focus:["Plant timing","Fast transition"],mistakes:["Choppy steps"],why:["Game rhythm & elastic timing"]},
  "Form jumps":{setup:["Feet under shoulders"],exec:["Jump straight; land soft; reset"],focus:["Quiet feet","Knees track"],mistakes:["Stomping"],why:["Pattern & landing control"]},
  "Touch rim/backboard":{setup:["Same approach each rep"],exec:["Reach tall; stick landing"],focus:["Consistency","Full extension"],mistakes:["Changing rhythm"],why:["Measurable peak reach timing"]},
  "Dunk attempts":{setup:["Same approach each rep"],exec:["Commit to takeoff"],focus:["Confidence; timing"],mistakes:["Indecision"],why:["Skill on top of power"]}
};

/* ----- Weeks/UI/logic (unchanged) ----- */
const WEEKS=12;
const listKey="osc_players";
const key=(p,d,w)=>`osc_p${p}_d${d}_w${w}`;
const settingsKey=(p)=>`osc_settings_${p}`;
const xpKey=(p)=>`osc_xp_${p}`;
const streakKey=(p)=>`osc_streak_${p}`;
const lastKey=(p)=>`osc_last_${p}`;
const earnedKey=(p)=>`osc_earned_${p}`;
const boundPlayerKey='osc_bound_player';

const daySel=document.getElementById('daySel');
const weekSel=document.getElementById('week');
const whyDiv=document.getElementById('why');
const content=document.getElementById('content');
const notes=document.getElementById('notes');
const xpEl=document.getElementById('xp');
const streakEl=document.getElementById('streak');
const exportBtn=document.getElementById('exportCsv');
const xpbar=document.getElementById('xpbar');
const badges=document.getElementById('badges');
const playerChip=document.getElementById('playerChip');

function loadSettings(p){ return JSON.parse(localStorage.getItem(settingsKey(p))||'{"school":"CORE Butte High","mascot":"Lynx","colors":"Blue & White","coachUrl":""}'); }
function saveSettings(p,s){ localStorage.setItem(settingsKey(p), JSON.stringify(s)); }
function loadEntry(p,d,w){ const raw=localStorage.getItem(key(p,d,w)); return raw?JSON.parse(raw):null; }
function saveEntry(p,d,w,val){ 
  localStorage.setItem(key(p,d,w), JSON.stringify(val));
    // fire-and-forget sync on every save
  sendCoachSnapshot();
}
function getXP(p){ return +(localStorage.getItem(xpKey(p))||0); }
function setXP(p,v){ localStorage.setItem(xpKey(p), v); }
function getStreak(p){ return +(localStorage.getItem(streakKey(p))||0); }
function setStreak(p,v){ localStorage.setItem(streakKey(p), v); }
function getLast(p){ return localStorage.getItem(lastKey(p)); }
function setLast(p,day){ localStorage.setItem(lastKey(p), day); }
function loadEarned(p){ return JSON.parse(localStorage.getItem(earnedKey(p))||'{}'); }
function saveEarned(p,m){ localStorage.setItem(earnedKey(p), JSON.stringify(m)); }

function currentPlayer(){ return localStorage.getItem(boundPlayerKey) || null; }
function promptForNameOnce(){
  let nm = localStorage.getItem(boundPlayerKey);
  if(nm) return nm;
  while(!nm){
    nm = (prompt("Enter your name to set up your app")||"").trim();
    if(!nm) alert("Name is required.");
  }
  localStorage.setItem(boundPlayerKey,nm);
  return nm;
}

function updateXPView(p){ const x=getXP(p); xpEl.textContent="XP "+x; const pct=Math.min(100,(x%100)); xpbar.style.width=pct+"%"; // Medals now shown per day completion, not XP
badges.innerHTML=""; }
function awardXPOnce(p,id,amt){ const m=loadEarned(p); if(m[id]) return; m[id]=amt; saveEarned(p,m); setXP(p,getXP(p)+amt); updateXPView(p); }

function init(day){ return {warmup: PROGRAM[day].warmup.map(()=>false),strength: PROGRAM[day].strength.map(b=>({weight:"",notes:"",sets:Array.from({length:b.sets},()=>({done:false}))})),core: PROGRAM[day].core.map(()=>false),jump: PROGRAM[day].jump.map(()=>false),notes:""}; }

function openTrainer(name){
  const base = name.split(' — ')[0];
  const d=EX[base]; if(!d) return;
  function fill(arr,id){ const el=document.getElementById(id); el.innerHTML=""; (arr||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); });}
  mTitle.textContent=base; fill(d.setup,'mSetup'); fill(d.exec,'mExec'); fill(d.focus,'mFocus'); fill(d.mistakes,'mMistakes'); fill(d.why,'mWhy');
  document.getElementById('trainerModal').style.display='flex';
}
document.getElementById('mClose').onclick=()=>document.getElementById('trainerModal').style.display='none';
document.getElementById('trainerModal').onclick=(e)=>{ if(e.target.id==='trainerModal') document.getElementById('trainerModal').style.display='none'; };

exportBtn.onclick=()=>{ const p=currentPlayer(),d=+daySel.value,w=+weekSel.value; const e=loadEntry(p,d,w)||init(d); const rows=[["Player","Week","Day","Section","Item","Set","Done","Weight","Notes","XP","Streak"]];
e.warmup.forEach((ck,i)=>rows.push([p,w,d,"Warmup",PROGRAM[d].warmup[i],"",ck?"yes":"","","",getXP(p),getStreak(p)]));
e.strength.forEach((blk,i)=>{ const ex=PROGRAM[d].strength[i].ex; blk.sets.forEach((st,si)=>rows.push([p,w,d,"Strength",ex,si+1,st.done?"yes":"",blk.weight||"",blk.notes||"",getXP(p),getStreak(p)])); });
e.core.forEach((ck,i)=>rows.push([p,w,d,"Core",PROGRAM[d].core[i],"",ck?"yes":"","","",getXP(p),getStreak(p)]));
e.jump.forEach((ck,i)=>rows.push([p,w,d,"Jump",PROGRAM[d].jump[i],"",ck?"yes":"","","",getXP(p),getStreak(p)]));
const csv=rows.map(r=>r.map(x=>`"${(x??"").toString().replace(/"/g,'""')}"`).join(",")).join("\n"); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download=`OSC_${p}_w${w}_d${d}.csv`; a.click(); };

function updatePhaseLabel(){ const w=+weekSel.value||1; document.getElementById('phaseLabel').textContent=(w<=6)?'Phase 1':'Phase 2'; }
function totalBoxes(d){ let t=0; t+=PROGRAM[d].warmup.length+PROGRAM[d].core.length+PROGRAM[d].jump.length; PROGRAM[d].strength.forEach(blk=>t+=blk.sets); return t; }
function currentDone(data,d){ let c=0; data.warmup.forEach(x=>{if(x)c++;}); data.core.forEach(x=>{if(x)c++;}); data.jump.forEach(x=>{if(x)c++;}); PROGRAM[d].strength.forEach((blk,i)=>data.strength[i].sets.forEach(s=>{if(s.done)c++;})); return c; }

function render(){
  updatePhaseLabel();
  const p=currentPlayer(); const d=+daySel.value; const w=+weekSel.value||1;
  playerChip.textContent = p ? `Player: ${p}` : "Player";
  const data=loadEntry(p,d,w)||init(d);// Check day completion for medals
const total=totalBoxes(d); 
const done=currentDone(data,d);
const dayComplete = (done === total && total > 0);
badges.innerHTML="";
const medals = [["Bronze",1],["Silver",2],["Gold",3]];
medals.forEach(([name,day])=>{
  const b=document.createElement('span');
  b.className='badge';
  const isDayComplete = (d===day && dayComplete);
  b.textContent=name+(isDayComplete?" ✓":"");
  badges.appendChild(b);
});
  updateXPView(p); updateStreak(p);
  whyDiv.innerHTML=PROGRAM[d].why.map(t=>"<div class='muted'>• "+t+"</div>").join("");
 xpbar.style.width=(100*done/total)+"%";
  content.innerHTML="";
  const warm=document.createElement('div'); warm.className="card"; warm.innerHTML="<strong>Warm-Up</strong>";
  PROGRAM[d].warmup.forEach((it,idx)=>{ const row=document.createElement('div'); row.className="row";
    const id=`wu_${d}_${idx}`; const cb=document.createElement('input'); cb.type="checkbox"; cb.checked=data.warmup[idx];
    cb.onchange=()=>{ data.warmup[idx]=cb.checked; saveEntry(p,d,w,data); if(cb.checked){ awardXPOnce(p,id,5); updateStreak(p);} xpbar.style.width=(100*currentDone(data,d)/total)+"%"; };
    const link=document.createElement('span'); link.className="exercise-link"; link.textContent=" "+it; link.onclick=()=>openTrainer(it);
    row.appendChild(cb); row.appendChild(link); warm.appendChild(row);
  });
  content.appendChild(warm);

  const str=document.createElement('div'); str.className="card"; str.innerHTML="<strong>Strength</strong><div class='grid gridHeader'><div>Exercise</div><div>Sets</div><div>Reps</div><div>Weight / Notes</div></div>";
  PROGRAM[d].strength.forEach((blk,bi)=>{ const g=document.createElement('div'); g.className="grid";
    const link=document.createElement('span'); link.className="exercise-link"; link.textContent=blk.ex; link.onclick=()=>openTrainer(blk.ex);
    const c1=document.createElement('div'); c1.appendChild(link); g.appendChild(c1);
    const c2=document.createElement('div'); c2.textContent=blk.sets; g.appendChild(c2);
    const c3=document.createElement('div'); c3.textContent=blk.reps; g.appendChild(c3);
    const c4=document.createElement('div');
    if(blk.weighted){ const winput=document.createElement('input'); winput.placeholder="lb"; winput.style.width="100%"; winput.value=(data.strength[bi].weight||""); winput.oninput=()=>{ data.strength[bi].weight=winput.value; saveEntry(p,d,w,data); }; c4.appendChild(winput); }
    const tarea=document.createElement('textarea'); tarea.className="note"; tarea.placeholder="Notes"; tarea.value=(data.strength[bi].notes||""); tarea.oninput=()=>{ data.strength[bi].notes=tarea.value; saveEntry(p,d,w,data); }; c4.appendChild(tarea);
    g.appendChild(c4); str.appendChild(g);
    const setRow=document.createElement('div'); setRow.className="row"; setRow.style.marginTop="6px";
    for(let s=0;s<blk.sets;s++){ const lb=document.createElement('label'); lb.className="row"; const cb=document.createElement('input'); cb.type="checkbox"; cb.checked=data.strength[bi].sets[s].done; const id=`st_${d}_${bi}_${s}`;
      cb.onchange=()=>{ data.strength[bi].sets[s].done=cb.checked; saveEntry(p,d,w,data); if(cb.checked) awardXPOnce(p,id,10); updateStreak(p); xpbar.style.width=(100*currentDone(data,d)/total)+"%"; };
      lb.appendChild(cb); lb.append(" Set "+(s+1)); setRow.appendChild(lb);
    }
    str.appendChild(setRow);
  });
  content.appendChild(str);

  const core=document.createElement('div'); core.className="card"; core.innerHTML="<strong>Core</strong>";
  PROGRAM[d].core.forEach((it,idx)=>{ const row=document.createElement('div'); row.className="row"; const id=`co_${d}_${idx}`; const cb=document.createElement('input'); cb.type="checkbox"; cb.checked=data.core[idx];
    cb.onchange=()=>{ data.core[idx]=cb.checked; saveEntry(p,d,w,data); if(cb.checked) awardXPOnce(p,id,5); updateStreak(p); xpbar.style.width=(100*currentDone(data,d)/total)+"%"; };
    const link=document.createElement('span'); link.className="exercise-link"; link.textContent=" "+it; link.onclick=()=>openTrainer(it);
    row.appendChild(cb); row.appendChild(link); core.appendChild(row);
  });
  content.appendChild(core);

  const jump=document.createElement('div'); jump.className="card"; jump.innerHTML="<strong>Jump Mechanics</strong>";
  PROGRAM[d].jump.forEach((it,idx)=>{ const row=document.createElement('div'); row.className="row"; const id=`jm_${d}_${idx}`; const cb=document.createElement('input'); cb.type="checkbox"; cb.checked=data.jump[idx];
    cb.onchange=()=>{ data.jump[idx]=cb.checked; saveEntry(p,d,w,data); if(cb.checked) awardXPOnce(p,id,8); updateStreak(p); xpbar.style.width=(100*currentDone(data,d)/total)+"%"; };
    const link=document.createElement('span'); link.className="exercise-link"; link.textContent=" "+it; link.onclick=()=>openTrainer(it);
    row.appendChild(cb); row.appendChild(link); jump.appendChild(row);
  });
  content.appendChild(jump);

  notes.value=(data.notes||""); notes.oninput=()=>{ data.notes=notes.value; saveEntry(p,d,w,data); };
}

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const sendCoachSnapshotDebounced = debounce(sendCoachSnapshot, 350);
// then in saveEntry(...), call:
saveEntry = (p,d,w,val)=>{
  localStorage.setItem(key(p,d,w), JSON.stringify(val));
  sendCoachSnapshotDebounced();
};
  
for(let w=1; w<=WEEKS; w++){ const o=document.createElement('option'); o.value=w; o.textContent="Week "+w; weekSel.appendChild(o); }
daySel.onchange=render; weekSel.onchange=render;

(function firstRun(){
  let p=currentPlayer();
  if(!p){ p = promptForNameOnce(); }
  playerChip.textContent = `Player: ${p}`;
  render();
})();
</script>
</body></html>
