<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0c204a">
  <title>Sky Core Coach Dashboard v2.0</title>
  <style>
    :root {
      --bg: #0c204a;
      --bg-elevated: #163678;
      --panel: #1a2238;
      --text: #e7eef9;
      --text-dim: #a0b8d6;
      --border: #263a64;
      --accent: #00d9ff;
      --accent-glow: rgba(0, 217, 255, 0.3);
      --gold: #ffd700;
      --green: #00ff88;
      --yellow: #ffb800;
      --red: #ff4d6d;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 20% 30%, rgba(0,217,255,0.08) 0%, transparent 40%),
                  radial-gradient(circle at 80% 70%, rgba(99,102,241,0.06) 0%, transparent 40%);
      pointer-events: none;
      z-index: 0;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* ===== HEADER ===== */
    header {
      text-align: center;
      padding: 32px 0 24px;
    }

    h1 {
      font-family: 'Rajdhani', sans-serif;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 4px;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    button {
      background: var(--panel);
      border: 2px solid var(--border);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      border-color: var(--accent);
      background: var(--bg-elevated);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.2);
    }

    /* ===== LOGIN CARD ===== */
    #loginCard {
      max-width: 400px;
      margin: 40px auto;
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 32px;
    }

    #loginCard input {
      width: 100%;
      margin: 16px 0;
      background: var(--bg);
      border: 2px solid var(--border);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 16px;
    }

    #loginCard button {
      width: 100%;
    }

    #loginErr {
      color: var(--red);
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
    }

    /* ===== TEAM OVERVIEW ===== */
    .team-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-box {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-box:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(0, 217, 255, 0.2);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
    }

    /* ===== PLAYER CARDS GRID ===== */
    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .player-card {
      background: var(--panel);
      border: 3px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .player-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
    }

    .player-card.on-track {
      border-color: var(--green);
    }

    .player-card.on-track:hover {
      box-shadow: 0 12px 32px rgba(0, 255, 136, 0.3);
    }

    .player-card.check-in {
      border-color: var(--yellow);
    }

    .player-card.check-in:hover {
      box-shadow: 0 12px 32px rgba(255, 184, 0, 0.3);
    }

    .player-card.at-risk {
      border-color: var(--red);
    }

    .player-card.at-risk:hover {
      box-shadow: 0 12px 32px rgba(255, 77, 109, 0.3);
    }

    .player-name {
      font-size: 24px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .player-meta {
      font-size: 14px;
      color: var(--text-dim);
      margin: 4px 0;
    }

    .player-status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .player-status.on-track {
      background: rgba(0, 255, 136, 0.15);
      color: var(--green);
    }

    .player-status.check-in {
      background: rgba(255, 184, 0, 0.15);
      color: var(--yellow);
    }

    .player-status.at-risk {
      background: rgba(255, 77, 109, 0.15);
      color: var(--red);
    }

    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--red);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 16px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-card:hover .delete-btn {
      opacity: 1;
    }

    .delete-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(255, 77, 109, 0.5);
    }

    /* ===== MODAL ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(16px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-box {
      background: linear-gradient(135deg, #1a2238 0%, #0f1729 100%);
      border: 3px solid var(--accent);
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 30px 90px rgba(0, 217, 255, 0.4);
      animation: slideUp 0.4s ease;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 24px 32px;
      border-bottom: 2px solid var(--accent);
      background: linear-gradient(135deg, #0e2a5f 0%, #1a2f5c 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 28px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
    }

    .modal-close {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-dim);
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-close:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--panel);
    }

    .modal-tabs {
      display: flex;
      gap: 8px;
      padding: 16px 32px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .tab-btn {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-dim);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tab-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4);
    }

    .modal-content {
      padding: 32px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* ===== OVERVIEW TAB ===== */
    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .overview-stat {
      background: rgba(0, 217, 255, 0.1);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .overview-stat-label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .overview-stat-value {
      font-size: 32px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
      color: var(--accent);
    }

    .section-breakdown {
      margin-top: 32px;
    }

    .section-item {
      background: rgba(255, 255, 255, 0.05);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .section-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .section-percentage {
      font-size: 18px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
    }

    .progress-bar {
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .player-notes {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 24px;
    }

    .notes-label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .notes-content {
      color: var(--text);
      line-height: 1.6;
    }

    /* ===== HISTORY TAB ===== */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .history-item {
      background: rgba(255, 255, 255, 0.05);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 16px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }

    .history-date {
      font-size: 12px;
      color: var(--text-dim);
    }

    .history-completion {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    /* ===== SAFETY TAB ===== */
    .safety-indicators {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .safety-indicator {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .safety-indicator.good {
      border-color: var(--green);
      background: rgba(0, 255, 136, 0.1);
    }

    .safety-indicator.warning {
      border-color: var(--yellow);
      background: rgba(255, 184, 0, 0.1);
    }

    .safety-indicator.danger {
      border-color: var(--red);
      background: rgba(255, 77, 109, 0.1);
    }

    .safety-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .safety-label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .safety-value {
      font-size: 24px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
    }

    .safety-indicator.good .safety-value {
      color: var(--green);
    }

    .safety-indicator.warning .safety-value {
      color: var(--yellow);
    }

    .safety-indicator.danger .safety-value {
      color: var(--red);
    }

    /* ===== PLACEHOLDER TABS ===== */
    .placeholder {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .placeholder-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .placeholder-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .placeholder-text {
      font-size: 14px;
    }

    .hidden {
      display: none;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .team-overview {
        grid-template-columns: repeat(2, 1fr);
      }

      .players-grid {
        grid-template-columns: 1fr;
      }

      .modal-box {
        max-width: 100%;
        border-radius: 16px;
      }

      .modal-tabs {
        overflow-x: auto;
      }

      .overview-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .safety-indicators {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LOGIN CARD -->
    <div id="loginCard">
      <h1 style="margin-bottom: 16px;">COACH LOGIN</h1>
      <input id="pw" type="password" placeholder="Enter Password">
      <button id="loginBtn">ENTER</button>
      <div id="loginErr" class="hidden">Incorrect password</div>
      <p style="margin-top: 16px; color: var(--text-dim); font-size: 12px; text-align: center;">
        Password: Lynx2025!
      </p>
    </div>

    <!-- MAIN APP (hidden until login) -->
    <div id="app" class="hidden">
      <header>
        <h1>OPERATION SKY CORE</h1>
        <p style="color: var(--text-dim); font-size: 14px; margin-top: 8px;">
          Coach Dashboard v2.0
        </p>
        <div class="header-actions">
          <button id="refreshBtn">üîÑ Refresh</button>
          <button id="exportBtn">üìä Export Report</button>
        </div>
      </header>

      <!-- TEAM OVERVIEW -->
      <div class="team-overview">
        <div class="stat-box">
          <div class="stat-label">Total Players</div>
          <div class="stat-value" id="statPlayers">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Avg XP</div>
          <div class="stat-value" id="statXP">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Active</div>
          <div class="stat-value" id="statActive">0%</div>
        </div>
      </div>

      <!-- PLAYER CARDS GRID -->
      <div class="players-grid" id="playersGrid"></div>
    </div>
  </div>

  <!-- PLAYER MODAL -->
  <div class="modal" id="playerModal">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">PLAYER</div>
        <button class="modal-close" id="modalClose">Close</button>
      </div>
      
      <div class="modal-tabs">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="history">History</button>
        <button class="tab-btn" data-tab="safety">Safety</button>
        <button class="tab-btn" data-tab="notes">Notes</button>
        <button class="tab-btn" data-tab="messages">Messages</button>
      </div>
      
      <div class="modal-content">
        <!-- Overview Tab -->
        <div class="tab-pane active" id="tab-overview"></div>
        
        <!-- History Tab -->
        <div class="tab-pane" id="tab-history"></div>
        
        <!-- Safety Tab -->
        <div class="tab-pane" id="tab-safety"></div>
        
        <!-- Notes Tab -->
        <div class="tab-pane" id="tab-notes">
          <div class="placeholder">
            <div class="placeholder-icon">üìù</div>
            <div class="placeholder-title">Coach Notes</div>
            <div class="placeholder-text">Coming in Phase 2 ‚Äî Real-time coach notes</div>
          </div>
        </div>
        
        <!-- Messages Tab -->
        <div class="tab-pane" id="tab-messages">
          <div class="placeholder">
            <div class="placeholder-icon">üí¨</div>
            <div class="placeholder-title">Direct Messaging</div>
            <div class="placeholder-text">Coming in Phase 2 ‚Äî Coach-to-player messaging</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const PASS = "Lynx2025!";
    const SESSION_KEY = "osc_coach_authed_v2";
    const POLL_INTERVAL = 30000; // 30 seconds
    
    let coachUrl = "";
    let pollTimer = null;
    let currentPlayerData = null;

    // ========== LOAD CONFIG ==========
    async function loadConfig() {
      try {
        let res = await fetch("./config.json?t=" + Date.now(), { cache: "no-store" });
        if (!res.ok) {
          res = await fetch("../config.json?t=" + Date.now(), { cache: "no-store" });
        }
        if (res.ok) {
          const config = await res.json();
          coachUrl = config.coachUrl || "";
        }
      } catch (err) {
        console.error("Config load failed:", err);
      }
    }

    // ========== LOGIN ==========
    const loginCard = document.getElementById('loginCard');
    const appEl = document.getElementById('app');
    const pw = document.getElementById('pw');
    const loginBtn = document.getElementById('loginBtn');
    const loginErr = document.getElementById('loginErr');

    function showApp() {
      loginCard.classList.add('hidden');
      appEl.classList.remove('hidden');
    }

    function requireLogin() {
      if (localStorage.getItem(SESSION_KEY) === "yes") {
        showApp();
        init();
        return;
      }
      loginCard.classList.remove('hidden');
      appEl.classList.add('hidden');
    }

    loginBtn.onclick = () => {
      if ((pw.value || "").trim() === PASS) {
        localStorage.setItem(SESSION_KEY, "yes");
        showApp();
        init();
      } else {
        loginErr.classList.remove('hidden');
        setTimeout(() => loginErr.classList.add('hidden'), 2000);
      }
    };

    pw.addEventListener('keydown', e => {
      if (e.key === "Enter") loginBtn.click();
    });

    // ========== DATA FETCHING ==========
    async function fetchPlayers() {
      if (!coachUrl) return { ok: false, players: {} };
      
      try {
        console.log("Fetching data from:", coachUrl);
        const res = await fetch(coachUrl + "?t=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        console.log("Received data:", data);
        return data;
      } catch (err) {
        console.error("Fetch failed:", err);
        return { ok: false, players: {} };
      }
    }

    // ========== DELETE PLAYER ==========
    async function deletePlayer(playerName) {
      if (!coachUrl) return false;
      
      try {
        const url = coachUrl + "?deletePlayer=" + encodeURIComponent(playerName);
        const res = await fetch(url);
        const data = await res.json();
        return data.ok === true;
      } catch (err) {
        console.error("Delete failed:", err);
        return false;
      }
    }

    // ========== RENDER ==========
    async function render() {
      const data = await fetchPlayers();
      
      if (!data.ok || !data.players) {
        console.error("Invalid data received");
        return;
      }
      
      const players = Object.values(data.players);
      
      // Update team stats
      updateTeamStats(players);
      
      // Render player cards
      renderPlayerCards(players);
    }

    function updateTeamStats(players) {
      const statPlayers = document.getElementById('statPlayers');
      const statXP = document.getElementById('statXP');
      const statActive = document.getElementById('statActive');
      
      const total = players.length;
      const avgXP = total > 0 ? Math.round(players.reduce((sum, p) => sum + p.xp, 0) / total) : 0;
      const activeCount = players.filter(p => p.safety.status !== 'at_risk').length;
      const activePercent = total > 0 ? Math.round((activeCount / total) * 100) : 0;
      
      statPlayers.textContent = total;
      statXP.textContent = avgXP;
      statActive.textContent = activePercent + '%';
    }

    function renderPlayerCards(players) {
      const grid = document.getElementById('playersGrid');
      grid.innerHTML = '';
      
      if (players.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 40px;">No players found</p>';
        return;
      }
      
      players.sort((a, b) => a.name.localeCompare(b.name));
      
      players.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card ' + player.safety.status.replace('_', '-');
        
        const statusEmoji = {
          'on_track': 'üî•',
          'check_in': '‚ö†Ô∏è',
          'at_risk': '‚ùå'
        };
        
        const statusText = {
          'on_track': 'ON TRACK',
          'check_in': 'CHECK IN',
          'at_risk': 'AT RISK'
        };
        
        card.innerHTML = `
          <button class="delete-btn" data-player="${escapeHtml(player.name)}">√ó</button>
          <div class="player-name">${escapeHtml(player.name)}</div>
          <div class="player-meta">Week ${player.currentWeek}, Day ${player.currentDay}</div>
          <div class="player-meta">${player.xp} XP</div>
          <div class="player-meta">${player.totalWorkouts} Workouts</div>
          <div class="player-status ${player.safety.status.replace('_', '-')}">
            ${statusEmoji[player.safety.status]} ${statusText[player.safety.status]}
          </div>
        `;
        
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            openPlayerModal(player);
          }
        });
        
        grid.appendChild(card);
      });
      
      // Attach delete handlers
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const playerName = btn.getAttribute('data-player');
          if (confirm(`Permanently delete ${playerName} from Sheets and dashboard?`)) {
            const success = await deletePlayer(playerName);
            if (success) {
              render();
            } else {
              alert("Delete failed. Check console for details.");
            }
          }
        });
      });
    }

    // ========== MODAL ==========
    const modal = document.getElementById('playerModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalClose = document.getElementById('modalClose');

    function openPlayerModal(player) {
      currentPlayerData = player;
      modalTitle.textContent = `${player.name.toUpperCase()} ‚Äî Week ${player.currentWeek}, Day ${player.currentDay}`;
      
      renderOverviewTab(player);
      renderHistoryTab(player);
      renderSafetyTab(player);
      
      modal.classList.add('show');
      
      // Stop polling while modal is open
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    function closePlayerModal() {
      modal.classList.remove('show');
      currentPlayerData = null;
      
      // Resume polling
      startPolling();
    }

    modalClose.onclick = closePlayerModal;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closePlayerModal();
      }
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update panes
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
      });
    });

    function renderOverviewTab(player) {
      const tab = document.getElementById('tab-overview');
      const workout = player.currentWorkout;
      
      tab.innerHTML = `
        <div class="overview-stats">
          <div class="overview-stat">
            <div class="overview-stat-label">Total XP</div>
            <div class="overview-stat-value">${player.xp}</div>
          </div>
          <div class="overview-stat">
            <div class="overview-stat-label">Workouts</div>
            <div class="overview-stat-value">${player.totalWorkouts}</div>
          </div>
          <div class="overview-stat">
            <div class="overview-stat-label">Progress</div>
            <div class="overview-stat-value">${workout.percentage}%</div>
          </div>
        </div>
        
        <h3 style="font-size: 20px; color: var(--accent); margin-bottom: 16px;">Current Workout</h3>
        
        <div class="section-breakdown">
          <div class="section-item">
            <div class="section-header">
              <div class="section-name">Warm-Up</div>
              <div class="section-percentage">${workout.sections.warmup.done}/${workout.sections.warmup.total}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${workout.sections.warmup.percentage}%"></div>
            </div>
          </div>
          
          <div class="section-item">
            <div class="section-header">
              <div class="section-name">Core</div>
              <div class="section-percentage">${workout.sections.core.done}/${workout.sections.core.total}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${workout.sections.core.percentage}%"></div>
            </div>
          </div>
          
          <div class="section-item">
            <div class="section-header">
              <div class="section-name">Jump</div>
              <div class="section-percentage">${workout.sections.jump.done}/${workout.sections.jump.total}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${workout.sections.jump.percentage}%"></div>
            </div>
          </div>
          
          <div class="section-item">
            <div class="section-header">
              <div class="section-name">Strength</div>
              <div class="section-percentage">${workout.sections.strength.done}/${workout.sections.strength.total}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${workout.sections.strength.percentage}%"></div>
            </div>
          </div>
        </div>
        
        ${workout.notes ? `
          <div class="player-notes">
            <div class="notes-label">Player Notes</div>
            <div class="notes-content">${escapeHtml(workout.notes)}</div>
          </div>
        ` : ''}
      `;
    }

    function renderHistoryTab(player) {
      const tab = document.getElementById('tab-history');
      const history = player.history || [];
      
      if (history.length === 0) {
        tab.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 40px;">No workout history</p>';
        return;
      }
      
      let html = '<div class="history-list">';
      
      history.forEach(workout => {
        html += `
          <div class="history-item">
            <div class="history-header">
              <div class="history-title">Week ${workout.week}, Day ${workout.day}</div>
              <div class="history-date">${workout.date}</div>
            </div>
            <div class="history-completion">${workout.completed}/${workout.total} exercises (${workout.percentage}%)</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${workout.percentage}%"></div>
            </div>
            ${workout.notes ? `<div style="margin-top: 8px; color: var(--text-dim); font-size: 13px;">${escapeHtml(workout.notes)}</div>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      tab.innerHTML = html;
    }

    function renderSafetyTab(player) {
      const tab = document.getElementById('tab-safety');
      const safety = player.safety;
      
      const warmupStatus = safety.warmupCompletionRate >= 80 ? 'good' : safety.warmupCompletionRate >= 60 ? 'warning' : 'danger';
      const coreStatus = safety.coreCompletionRate >= 80 ? 'good' : safety.coreCompletionRate >= 60 ? 'warning' : 'danger';
      const activityStatus = safety.daysSinceLastWorkout <= 3 ? 'good' : safety.daysSinceLastWorkout <= 7 ? 'warning' : 'danger';
      const frequencyStatus = safety.workoutFrequency === '3x/week' || safety.workoutFrequency === 'Good' ? 'good' : safety.workoutFrequency === 'Low' ? 'warning' : 'danger';
      
      const statusIcon = { 'good': '‚úÖ', 'warning': '‚ö†Ô∏è', 'danger': '‚ùå' };
      
      tab.innerHTML = `
        <div class="safety-indicators">
          <div class="safety-indicator ${warmupStatus}">
            <div class="safety-icon">${statusIcon[warmupStatus]}</div>
            <div class="safety-label">Warm-Up Completion</div>
            <div class="safety-value">${safety.warmupCompletionRate}%</div>
          </div>
          
          <div class="safety-indicator ${coreStatus}">
            <div class="safety-icon">${statusIcon[coreStatus]}</div>
            <div class="safety-label">Core Work Completion</div>
            <div class="safety-value">${safety.coreCompletionRate}%</div>
          </div>
          
          <div class="safety-indicator ${activityStatus}">
            <div class="safety-icon">${statusIcon[activityStatus]}</div>
            <div class="safety-label">Last Activity</div>
            <div class="safety-value">${safety.daysSinceLastWorkout} days ago</div>
          </div>
          
          <div class="safety-indicator ${frequencyStatus}">
            <div class="safety-icon">${statusIcon[frequencyStatus]}</div>
            <div class="safety-label">Workout Frequency</div>
            <div class="safety-value">${safety.workoutFrequency}</div>
          </div>
        </div>
      `;
    }

    // ========== EXPORT ==========
    document.getElementById('exportBtn').onclick = async () => {
      const data = await fetchPlayers();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `sky_core_team_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    };

    // ========== REFRESH ==========
    document.getElementById('refreshBtn').onclick = render;

    // ========== POLLING ==========
    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(render, POLL_INTERVAL);
    }

    // ========== HELPERS ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== INIT ==========
    async function init() {
      await loadConfig();
      await render();
      startPolling();
    }

    // Start
    requireLogin();
  </script>
</body>
</html>
